<?php	 

	include_once("../clases/conexion.php");
	$conexion= new conexion();
	$funcion=trim($_POST["funcion"]);
	
	if ($funcion==1)
	{
		$id_usuario=trim($_POST["id_usuario"]);
		try{
				/*$sql3="INSERT INTO proforma	 (id_usuario)
				VALUES ('$id_usuario')";
				$resultado=mysql_query($sql3,$conexion->link);
				$valor=mysql_insert_id();*/
				$sql2="SELECT MAX(id_temporal_proforma	) FROM temporal_proforma";						
				$ejecuta2=mysql_query($sql2,$conexion->link);			
				$fila2 = mysql_fetch_array($ejecuta2);
				echo $fila2[0]+1;	
				echo $valor;
		}
			catch (Exception $e)
		{    
			echo $e->getMessage();
		}
	}
	else if ($funcion==2)
	{
		$numero_proforma=trim($_POST["numero_proforma"]);
		$id_cliente_int=trim($_POST["id_cliente_int"]);
		$fecha_proforma=trim($_POST["fecha_proforma"]);
		$id_centro_venta=trim($_POST["id_centro_venta"]);
		$medio_transporte=trim($_POST["medio_transporte"]);
		$puerto_embarque=utf8_decode(trim($_POST["puerto_embarque"]));
		$puerto_destino=utf8_decode(trim($_POST["puerto_destino"]));
		$cond_pago=trim($_POST["cond_pago"]);
		$id_tipo_moneda=utf8_decode(trim($_POST["id_tipo_moneda"]));
		$clausula_venta=trim($_POST["clausula_venta"]);
		$descripcion=utf8_decode(trim($_POST["descripcion"]));
		$subtotal=trim($_POST["subtotal"]);
		$descuento=trim($_POST["descuento"]);
		$freight=trim($_POST["freight"]);
		$insurance=trim($_POST["insurance"]);
		$total=trim($_POST["total"]);
		$fecha_proforma2=date("Y-m-d",strtotime($fecha_proforma));
		$version=trim($_POST["version"]);
		try{

				$sql="INSERT INTO proforma 
				(numero_proforma,
				id_cliente,
				fecha_proforma,
				id_centro_venta,
				medio_de_transporte,
				puerto_embarque,
				puerto_destino,
				ingresada,
				forma_pago,
				id_tipo_moneda,
				clausula_venta,
				total,
				descripcion_mercaderia,
				subtotal,
				freight,
				insurance,
				version,
				descuento)
				VALUES ('$numero_proforma','$id_cliente_int','$fecha_proforma2','$id_centro_venta','$medio_transporte','$puerto_embarque',				'$puerto_destino','Si','$cond_pago','$id_tipo_moneda','$clausula_venta','$total','$descripcion','$subtotal','$freight','$insurance','$version','$descuento')";
				$resultado=mysql_query($sql,$conexion->link);

				$sql1="SELECT numero_proforma,Cantidad,id_producto,Precio,total FROM temporal_detalle_proforma
				where numero_proforma=".$numero_proforma;
				$resultado1=mysql_query($sql1,$conexion->link);
				while ($fila1 = mysql_fetch_array($resultado1))
				{
					$sql4="INSERT INTO detalle_proforma (numero_proforma,Cantidad,id_producto,Precio,total)
					VALUES ('$fila1[0]','$fila1[1]','$fila1[2]','$fila1[3]','$fila1[4]')";
					$resultado=mysql_query($sql4,$conexion->link);								
				}
				echo "Proforma Ingresada Numero ".$numero_proforma;
		}
			catch (Exception $e)
		{    
			echo $e->getMessage();
		}
	}
	else if ($funcion==3)
	{
		try{
				$sql2="SELECT MAX(id_temporal_proforma) FROM temporal_proforma";						
				$ejecuta2=mysql_query($sql2,$conexion->link);			
				$fila2 = mysql_fetch_array($ejecuta2);
				echo $fila2[0]+1;
		}
			catch (Exception $e)
		{    
			echo $e->getMessage();
		}
	}
	else if ($funcion==4)
	{
		$numero_proforma=trim($_POST["numero_proforma"]);
		$sql2="SELECT MAX(id_temporal_proforma) FROM temporal_proforma";						
		$ejecuta2=mysql_query($sql2,$conexion->link);			
		$fila2 = mysql_fetch_array($ejecuta2);
		$valor=$fila2[0]+1;
		if ($numero_proforma==$valor)
		{
			echo "1";
		}
		else if ($numero_proforma<$valor)
		{
			echo "3";
		}
		else if ($numero_proforma>$valor)
		{
			echo "2";
		}
	}
	else if ($funcion==5)
	{
		$numero_proforma=trim($_POST["numero_proforma"]);
		$sql="select 
				cliente_internacional.nombre_cliente,
				DATE_FORMAT(proforma.fecha_proforma,'%d-%m-%Y') as fecha,
				centro_venta.centro_venta,
				proforma.version,
				proforma.medio_de_transporte,
				proforma.puerto_embarque,
				proforma.puerto_destino,
				proforma.forma_pago,
				proforma.descripcion_mercaderia,
				cliente_internacional.direccion,
				paises.pais,
				tipos_de_monedas.tipo_moneda,
				proforma.Subtotal,
				proforma.total,
				proforma.clausula_venta,
				proforma.descuento,
				proforma.insurance,
				proforma.freight				
				from 
				proforma
				inner join cliente_internacional on cliente_internacional.id_cliente=proforma.id_cliente
				inner join tipos_de_monedas on tipos_de_monedas.id_tipo_moneda=proforma.id_tipo_moneda
				inner join centro_venta on centro_venta.id_centro_venta=proforma.id_centro_venta
				inner join paises on paises.id_pais=cliente_internacional.id_pais
				where proforma.numero_proforma=".$numero_proforma;	
		$ejecuta=mysql_query($sql,$conexion->link);
		$numero_filas = mysql_num_rows($ejecuta);
		if ($numero_filas==0)
		{		 
			$salida[]=array("valor"=>1);
		 	echo json_encode($salida);
		}
		else
		{
			while ($fila = mysql_fetch_array($ejecuta))
			{
				$salida[]=array("cliente"=>utf8_encode($fila[0]),"fecha_proforma"=>$fila[1],"centro_venta"=>$fila[2]
				,"version"=>$fila[3],"medio_de_transporte"=>utf8_encode($fila[4]),"puerto_embarque"=>utf8_encode($fila[5]),
					"puerto_destino"=>utf8_encode($fila[6]),"forma_pago"=>utf8_encode($fila[7]),"descripcion_mercaderia"=>$fila[8]
					,"direccion"=>$fila[9],"pais"=>$fila[10],"tipo_moneda"=>$fila[11],"sub_total"=>$fila[12],"total"=>$fila[13],
					"clausula_venta"=>$fila[14],"descuento"=>$fila[15],"insurance"=>$fila[16],"freight"=>$fila[17]);
			}
			echo json_encode($salida);
		}
	}
	else if ($funcion==6)
	{
		$numero_proforma=trim($_POST["numero_proforma"]);
		$sql2="select
					detalle_proforma.id_detalle_proforma,
					productos.nombre_producto,
					productos.codigo_producto,
					detalle_proforma.cantidad,
					detalle_proforma.precio,
					detalle_proforma.total,
					proforma.facturada
					from detalle_proforma
					inner join proforma on proforma.numero_proforma=detalle_proforma.numero_proforma
					inner join productos on productos.id_producto=detalle_proforma.id_producto	
					WHERE detalle_proforma.numero_proforma=".$numero_proforma;			
		$resultado2=mysql_query($sql2,$conexion->link);
		while ($mensaje2=mysql_fetch_array($resultado2))
		{						
			echo	"<tr id=".$mensaje2[0].">";
			echo	"<td>".$mensaje2[2]."</td>";
			echo	"<td>".utf8_encode($mensaje2[1])."</td>";
			echo	"<td>".$mensaje2[3]."</td>";
			echo	"<td>".$mensaje2[4]."</td>";
			echo	"<td>".number_format($mensaje2[5])."</td>";
			if ($mensaje2[6]<>'Si')
			{
				echo	"<td><a href='#' title='Borrar Informacion' onClick='$(this).elimina_prod_detalle_proforma(".$mensaje2[0].",".$numero_proforma.");'class='icon-borrar info-tooltip'></a></td>";
				echo	"<td><a href='#' title='Editar Informacion' onClick='$(this).editar_prod_detalle_proforma_version(".$mensaje2[0].",".$numero_proforma.");'class='icon-editar info-tooltip'></a></td>";
			}
			else
			{
				echo	"<td></td>";
			}		
			echo "</tr>";	
		}
	}
	else if ($funcion==7)
	{
		$numero_proforma=trim($_POST["numero_proforma"]);			
		$sql="INSERT INTO proforma_historico
			SELECT * FROM proforma where numero_proforma=".$numero_proforma;
		$ejecuta=mysql_query($sql,$conexion->link);

		$sql1="SELECT version FROM proforma where numero_proforma=".$numero_proforma;
		$ejecuta1=mysql_query($sql1,$conexion->link);
		$fila1=mysql_fetch_array($ejecuta1);
		$dato=$fila1[0]+1;

		$sql2="UPDATE proforma set version=".$dato." where numero_proforma=".$numero_proforma;
		$resultado2=mysql_query($sql2,$conexion->link);

		$sql3=" SELECT Cantidad,id_producto,Precio,total FROM detalle_proforma where numero_proforma=".$numero_proforma;
		$ejecuta3=mysql_query($sql3,$conexion->link);
		while ($fila3=mysql_fetch_array($ejecuta3))
		{	
			$sql4="SELECT version FROM proforma where numero_proforma=".$numero_proforma;
			$ejecuta4=mysql_query($sql4,$conexion->link);
			$fila4=mysql_fetch_array($ejecuta4);

			$sql5="INSERT INTO detalle_proforma_historica (numero_proforma,Cantidad,id_producto,Precio,total)
			VALUES
			('$numero_proforma','$fila3[0]','$fila3[1]','$fila3[2]','$fila3[3]')";
			$resultado5=mysql_query($sql5,$conexion->link);
			$valor=mysql_insert_id();
			$dato2=($fila4[0]-(1));

			$sql6="UPDATE detalle_proforma_historica	 
				set 		 
				version=".$dato2.
				" where id_detalle_proforma=".$valor;
			$resultado6=mysql_query($sql6,$conexion->link);			
		}
		echo $dato;
	}
	else if ($funcion==8)
	{
		$numero_proforma=trim($_POST["numero_proforma"]);
		$sql2="select
					detalle_proforma.id_detalle_proforma,
					productos.nombre_producto,
					productos.codigo_producto,
					detalle_proforma.cantidad,
					detalle_proforma.total,
					detalle_proforma.precio,
					proforma.facturada
					from detalle_proforma
					inner join proforma on proforma.numero_proforma=detalle_proforma.numero_proforma
					inner join productos on productos.id_producto=detalle_proforma.id_producto	
					WHERE detalle_proforma.numero_proforma=".$numero_proforma;			
		$resultado2=mysql_query($sql2,$conexion->link);
		while ($mensaje2=mysql_fetch_array($resultado2))
		{						
			echo	"<tr id=".$mensaje2[0].">";
			echo	"<td>".$mensaje2[2]."</td>";
			echo	"<td>".utf8_encode($mensaje2[1])."</td>";
			echo	"<td>".$mensaje2[3]."</td>";
		}
	}
	else if ($funcion==9)
	{
		$id_aduana=trim($_POST["id_aduana"]);
		$sql="select
					rut,
					direccion,
					ciudad,
					fono
					from aduanas
					WHERE id_aduana=".$id_aduana;			
		$ejecuta=mysql_query($sql,$conexion->link);
		while ($fila = mysql_fetch_array($ejecuta))
		{
			$salida[]=array("rut"=>$fila[0],"direccion"=>utf8_encode($fila[1]),"ciudad"=>utf8_encode($fila[2]),"fono"=>$fila[3]);
		}
		echo json_encode($salida);
	}
	else if ($funcion==10)
	{
		$nave=trim($_POST["nave"]);
		$contenedor=trim($_POST["contenedor"]);
		$movil=trim($_POST["movil"]);
		$patente=trim($_POST["patente"]);
		$id_aduana=trim($_POST["id_aduana"]);	
		$num_proforma=trim($_POST["num_proforma"]);	
		$num_guia=trim($_POST["num_guia"]);	
		$fecha=date("y-m-d H:i:s");
		$proforma=trim($_POST["proforma"]);
		

		$sql="INSERT INTO guias_despachos (numero_guia_despacho,nave,contenedor,movil,patente,numero_proforma,id_aduana,fecha)
			VALUES
			('$num_guia','$nave','$contenedor','$movil','$patente','$num_proforma','$id_aduana','$fecha')";
		$resultado=mysql_query($sql,$conexion->link);
		$guia=mysql_insert_id();
		$sql1="UPDATE proforma	 
			set 		 
			despachada='Si' where numero_proforma=".$proforma;
		$resultado1=mysql_query($sql1,$conexion->link);	

		echo "Guia de Despacho Ingresada Numero ".$num_guia;
	}
	else if ($funcion==11)
	{
		$numero_proforma=trim($_POST["numero_proforma"]);
		$sql="SELECT numero_proforma FROM guias_despachos where numero_proforma=".$numero_proforma;						
		$ejecuta=mysql_query($sql,$conexion->link);			
		$fila = mysql_fetch_array($ejecuta);
		if ($fila[0]<>"")
		{
			echo "1";
		}
		else
		{
			echo "2";
		}
	}
	else if ($funcion==12)
	{
		$numero_proforma=trim($_POST["numero_proforma"]);
		$sql="select 
				guias_despachos.numero_guia_despacho,
				guias_despachos.nave,
				guias_despachos.contenedor,
				guias_despachos.movil,
				guias_despachos.patente,
				aduanas.nombre_aduana,
				aduanas.rut,
				aduanas.direccion,
				aduanas.ciudad,
				aduanas.fono,
				cliente_internacional.nombre_cliente,
				guias_despachos.id_guia_despacho
				from 
				guias_despachos
				inner join aduanas on aduanas.id_aduana=guias_despachos.id_aduana
				inner join proforma on proforma.numero_proforma=guias_despachos.numero_proforma
				inner join cliente_internacional on cliente_internacional.id_cliente=proforma.id_cliente
				where guias_despachos.numero_proforma=".$numero_proforma;	
		$ejecuta=mysql_query($sql,$conexion->link);
		$numero_filas = mysql_num_rows($ejecuta);
		if ($numero_filas==0)
		{		 
			$salida[]=array("valor"=>1);
		 	echo json_encode($salida);
		}
		else
		{
			while ($fila = mysql_fetch_array($ejecuta))
			{
				$salida[]=array("numero_guia_despacho"=>$fila[0],"nave"=>utf8_encode($fila[1]),"contenedor"=>utf8_encode($fila[2]),
					"movil"=>utf8_encode($fila[3]),"patente"=>utf8_encode($fila[4]),"nombre_aduana"=>utf8_encode($fila[5])
					,"rut"=>$fila[6],"direccion"=>utf8_encode($fila[7]),"ciudad"=>utf8_encode($fila[8]),"fono"=>$fila[9],"cliente"=>$fila[10]
					,"id_guia_despacho"=>$fila[11]);
			}
			echo json_encode($salida);
		}
	}
	else if ($funcion==13)
	{
		$num_guia=trim($_POST["num_guia"]);
		$id_guia=trim($_POST["id_guia"]);		
		$sql="SELECT numero_guia_despacho FROM guias_despachos where numero_guia_despacho=".$num_guia." where id_guia_despacho=".$id_guia;				
		$ejecuta=mysql_query($sql,$conexion->link);			
		$fila = mysql_fetch_array($ejecuta);
		if ($fila[0]<>"")
		{
			echo "1";
		}
		else
		{
			echo "2";
		}
	}
	else if ($funcion==14)
	{
		$nave=trim($_POST["nave"]);
		$contenedor=trim($_POST["contenedor"]);
		$movil=trim($_POST["movil"]);
		$patente=trim($_POST["patente"]);
		$id_aduana=trim($_POST["id_aduana"]);	
		$num_proforma=trim($_POST["num_proforma"]);	
		$num_guia=trim($_POST["num_guia"]);	
		$id_guia=trim($_POST["id_guia"]);	
		$fecha=date("y-m-d H:i:s");
		$sql="UPDATE guias_despachos	 
					set 		 
					numero_guia_despacho='".$num_guia."',
					nave='".$nave."',
					contenedor='".$contenedor."',
					movil='".$movil."',
					patente='".utf8_decode($patente)."',
					fecha='".$fecha."',
					id_aduana='".$id_aduana."'
					where id_guia_despacho=".$id_guia;
		$resultado=mysql_query($sql,$conexion->link);
		echo "Guia de Despacho Modificada";
	}
	else if ($funcion==15)
	{
		$numero_proforma=trim($_POST["numero_proforma"]);
		$sql2="select
					detalle_proforma.id_detalle_proforma,
					productos.nombre_producto,
					productos.codigo_producto,
					detalle_proforma.cantidad,
					detalle_proforma.precio,
					detalle_proforma.total,
					proforma.facturada
					from detalle_proforma
					inner join proforma on proforma.numero_proforma=detalle_proforma.numero_proforma
					inner join productos on productos.id_producto=detalle_proforma.id_producto	
					WHERE detalle_proforma.numero_proforma=".$numero_proforma;			
		$resultado2=mysql_query($sql2,$conexion->link);
		while ($mensaje2=mysql_fetch_array($resultado2))
		{						
			echo	"<tr id=".$mensaje2[0].">";
			echo	"<td>".$mensaje2[2]."</td>";
			echo	"<td>".utf8_encode($mensaje2[1])."</td>";
			echo	"<td>".$mensaje2[3]."</td>";
			echo	"<td>".$mensaje2[4]."</td>";
			echo	"<td>".number_format($mensaje2[5])."</td>";
			if ($mensaje2[6]<>'Si')
			{
				echo	"<td><a href='#' title='Borrar Informacion' onClick='$(this).cambio_proforma_version_modifca(".$mensaje2[0].",".$numero_proforma.");'class='icon-borrar info-tooltip'></a></td>";
				echo	"<td><a href='#' title='Editar Informacion' onClick='$(this).cambio_proforma_version_modifca(".$mensaje2[0].",".$numero_proforma.");'class='icon-editar info-tooltip'></a></td>";
			}
			else
			{
				echo	"<td></td>";
			}		
			echo "</tr>";	
		}
	}
	else if ($funcion==16)
	{
		$numero_proforma=trim($_POST["numero_proforma"]);
		$id_cliente_int=trim($_POST["id_cliente_int"]);
		$fecha_proforma=trim($_POST["fecha_proforma"]);
		$id_centro_venta=trim($_POST["id_centro_venta"]);
		$medio_transporte=trim($_POST["medio_transporte"]);
		$puerto_embarque=utf8_decode(trim($_POST["puerto_embarque"]));
		$puerto_destino=utf8_decode(trim($_POST["puerto_destino"]));
		$cond_pago=trim($_POST["cond_pago"]);
		$id_tipo_moneda=utf8_decode(trim($_POST["id_tipo_moneda"]));
		$clausula_venta=trim($_POST["clausula_venta"]);
		$descripcion=utf8_decode(trim($_POST["descripcion"]));
		$subtotal=trim($_POST["subtotal"]);
		$descuento=trim($_POST["descuento"]);
		$freight=trim($_POST["freight"]);
		$insurance=trim($_POST["insurance"]);
		$total=trim($_POST["total"]);
		$fecha_proforma2=date("Y-m-d",strtotime($fecha_proforma));
		$version=trim($_POST["version"]);
		try{

			$sql1="UPDATE proforma	 
					set 		 
					id_cliente='".$id_cliente_int."',
					fecha_proforma='".$fecha_proforma2."',
					id_centro_venta='".$id_centro_venta."',
					medio_de_transporte='".$medio_transporte."',
					puerto_embarque='".utf8_decode($puerto_embarque)."',
					puerto_destino='".utf8_decode($puerto_destino)."',
					ingresada='Si',
					forma_pago='".utf8_decode($cond_pago)."',
					id_tipo_moneda='".$id_tipo_moneda."',
					clausula_venta='".$clausula_venta."',
					total='".$total."',
					descripcion_mercaderia='".utf8_decode($descripcion)."',
					subtotal='".$subtotal."',
					freight='".$freight."',
					insurance='".$insurance."',
					version='".$version."',
					descuento='".$descuento."'
					where numero_proforma=".$numero_proforma;
				$resultado2=mysql_query($sql1,$conexion->link);	 
			
				
				echo "Proforma Actualizada Numero ".$numero_proforma;
		}
			catch (Exception $e)
		{    
			echo $e->getMessage();
		}
	}
	else if ($funcion==17)
	{
		$numero_guia=trim($_POST["numero_guia"]);
		$sql="SELECT numero_guia_despacho FROM guias_despachos where numero_guia_despacho=".$numero_guia;				
		$ejecuta=mysql_query($sql,$conexion->link);			
		$fila = mysql_fetch_array($ejecuta);
		if ($fila[0]<>"")
		{
			echo "1";
		}
		else
		{
			echo "2";
		}
	}
	else if ($funcion==18)
	{
		$numero_guia=trim($_POST["numero_guia"]);
		$sql2="select
					detalle_proforma.id_detalle_proforma,
					detalle_proforma.cantidad,
					productos.nombre_producto,
					formatos.formato,
					productos.Peso_Bruto,
					productos.Volumen,
					productos.peso_neto,
					cliente_internacional.nombre_cliente,
					factura_internacional.numero_factura,
					guias_despachos.contenedor
					from detalle_proforma
					inner join proforma on proforma.numero_proforma=detalle_proforma.numero_proforma
					inner join productos on productos.id_producto=detalle_proforma.id_producto	
					inner join formatos on formatos.id_formato=productos.id_formato	
					inner join guias_despachos on guias_despachos.numero_proforma=proforma.numero_proforma
					inner join factura_internacional on factura_internacional.numero_proforma=proforma.numero_proforma
					inner join cliente_internacional on cliente_internacional.id_cliente=factura_internacional.id_cliente
					WHERE guias_despachos.numero_guia_despacho=".$numero_guia;			
		$resultado2=mysql_query($sql2,$conexion->link);
		while ($mensaje2=mysql_fetch_array($resultado2))
		{		
			$peso_bruto=$mensaje2[1]*$mensaje2[4];
			$peso_neto=$mensaje2[1]*$mensaje2[6];
			$volumen=$mensaje2[1]*$mensaje2[5];
			echo	"<tr id=".$mensaje2[0].">";
			echo	"<td>".$mensaje2[1]."</td>";
			echo	"<td>".utf8_encode($mensaje2[2])."</td>";
			echo	"<td>".$mensaje2[3]."</td>";
			echo	"<td>".$peso_bruto."</td>";
			echo	"<td>".$peso_neto."</td>";
			echo	"<td>".$volumen."</td>";
			echo	"<input type='hidden' id='cliente_nom' value=".$mensaje2[7].">";
			echo	"<input type='hidden' id='factura_num' value=".$mensaje2[8].">";
			echo	"<input type='hidden' id='contenedor_num' value=".$mensaje2[9].">";
		echo "</tr>";	
		}		
	}
	else if ($funcion==19)
	{
		$numero_proforma=trim($_POST["numero_proforma"]);
		$sql="SELECT facturada FROM proforma where numero_proforma=".$numero_proforma;				
		$ejecuta=mysql_query($sql,$conexion->link);			
		$fila = mysql_fetch_array($ejecuta);
		if ($fila[0]<>"")
		{
			echo "1";
		}
		else
		{
			$numero_proforma=trim($_POST["numero_proforma"]);
			$sql2="SELECT rechazada FROM proforma where numero_proforma=".$numero_proforma;				
			$ejecuta2=mysql_query($sql2,$conexion->link);	
			$fila2 = mysql_fetch_array($ejecuta2);
			if ($fila2[0]<>"")
			{
				echo "3";
			}
			else
			{
				echo "2";
			}
		}		
	}
	else if ($funcion==20)
	{
		$numero_proforma=trim($_POST["numero_proforma"]);
		$sql="SELECT ingresada FROM proforma where numero_proforma=".$numero_proforma;				
		$ejecuta=mysql_query($sql,$conexion->link);			
		$fila = mysql_fetch_array($ejecuta);
		if ($fila[0]<>"")
		{
			echo "1";
		}
		else
		{
			echo "2";
		}		
	}
?>	